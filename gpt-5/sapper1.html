<!--–ù–∞–ø–∏—à–∏ –≤–µ–± –≤–µ—Ä—Å–∏—é —Å–∞–ø–µ—Ä–∞-->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–∞–ø—ë—Ä</title>
  <style>
    :root{
      --cell-size: 28px;   /* –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —à–∏—Ä–∏–Ω—É */
      --cols: 9;
      --bg: #c0c0c0;
      --panel: #cfcfcf;
      --bevel-light: #ffffff;
      --bevel-dark: #7d7d7d;
      --open-bg: #e9e9e9;
      --shadow: rgba(0,0,0,0.15);
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
      color:#222;
      background: linear-gradient(180deg, #f6f7f9 0%, #eef1f4 100%);
      display:grid;
      place-items:center;
    }
    .game{
      background: var(--bg);
      border: 2px solid #8a8a8a;
      border-right-color: #444;
      border-bottom-color: #444;
      border-left-color: #ddd;
      border-top-color: #ddd;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 8px 24px var(--shadow);
      max-width: 95vw;
      user-select: none;
    }
    .top{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
      margin-bottom:10px;
    }
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .panel{
      background: var(--panel);
      border: 2px solid #8a8a8a;
      border-right-color: #444;
      border-bottom-color: #444;
      border-left-color: #fff;
      border-top-color: #fff;
      padding: 6px 8px;
      border-radius: 4px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .counter{
      font: 700 20px/1.1 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #111;
      color: #e22;
      padding: 4px 6px;
      border-radius: 3px;
      min-width: 58px;
      text-align:center;
      letter-spacing: 1px;
    }
    .counter.blue{ color:#1ee; }
    .btn, select, input[type="number"]{
      height: 34px;
      padding: 0 10px;
      border-radius: 6px;
      border: 1px solid #b5b5b5;
      background: #f7f7f7;
      color:#222;
      box-shadow: inset 0 1px 0 #fff, 0 1px 0 rgba(255,255,255,0.3);
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover{ background: #fff; }
    .btn.primary{
      background: #1976d2;
      border-color: #0e60b1;
      color: #fff;
    }
    .btn.primary:hover{ background:#1e88e5; }
    .btn.toggle.active{
      background:#ffe08a;
      border-color:#e3b542;
    }
    .face{
      width:36px; height:36px; display:grid; place-items:center;
      font-size:20px; line-height:1;
    }
    .custom{
      display:none;
      gap:6px;
      align-items:center;
    }
    .custom input{ width:80px; }
    .custom.show{ display:flex; }

    .board-wrap{
      background: var(--panel);
      border: 2px solid #8a8a8a;
      border-right-color: #444;
      border-bottom-color: #444;
      border-left-color: #fff;
      border-top-color: #fff;
      padding: 6px;
      border-radius: 4px;
      overflow:auto;
      max-height: calc(100vh - 200px);
    }
    .board{
      display:grid;
      grid-template-columns: repeat(var(--cols), var(--cell-size));
      grid-auto-rows: var(--cell-size);
      gap: 0;
      touch-action: manipulation;
    }
    .cell{
      appearance:none;
      -webkit-appearance:none;
      border: none;
      margin: 0;
      padding: 0;
      width: var(--cell-size);
      height: var(--cell-size);
      background: #c0c0c0;
      border-top: 2px solid var(--bevel-light);
      border-left: 2px solid var(--bevel-light);
      border-right: 2px solid var(--bevel-dark);
      border-bottom: 2px solid var(--bevel-dark);
      display:grid; place-items:center;
      font-weight: 700;
      font-size: calc(var(--cell-size) * 0.52);
      cursor: pointer;
      line-height: 1;
      user-select: none;
      position:relative;
    }
    .cell:focus-visible{
      outline: 2px solid #ff9800;
      outline-offset: -2px;
      z-index: 1;
    }
    .cell.open{
      background: var(--open-bg);
      border-top: 2px solid #9e9e9e;
      border-left: 2px solid #9e9e9e;
      border-right: 2px solid #bdbdbd;
      border-bottom: 2px solid #bdbdbd;
      cursor: default;
    }
    .cell.flag{ color:#d32f2f; }
    .cell.mine{ background:#f2b8b8; }
    .cell.hit{ background:#e53935; color:#fff; }
    .n1{ color:#1976d2; }
    .n2{ color:#2e7d32; }
    .n3{ color:#d32f2f; }
    .n4{ color:#512da8; }
    .n5{ color:#8d6e63; }
    .n6{ color:#00838f; }
    .n7{ color:#000; }
    .n8{ color:#616161; }

    .hint{
      font-size: 12px; color:#333; opacity:0.8;
    }
    .footer{
      margin-top:8px; display:flex; justify-content:space-between; align-items:center;
      color:#444; font-size:12px;
    }
    .status{
      min-height: 18px;
      font-weight:600;
    }
    .status.win{ color:#2e7d32; }
    .status.lose{ color:#d32f2f; }

    /* Scrollbars (nice) */
    .board-wrap::-webkit-scrollbar{ height:10px; width:10px; }
    .board-wrap::-webkit-scrollbar-thumb{ background:#c1c1c1; border-radius:6px; }
    .board-wrap::-webkit-scrollbar-track{ background:#efefef; }
  </style>
</head>
<body>
  <div class="game" id="game">
    <div class="top">
      <div class="controls">
        <div class="panel">
          <label for="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å:</label>
          <select id="difficulty" title="–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å">
            <option value="novice">–ù–æ–≤–∏—á–æ–∫ (9√ó9, 10)</option>
            <option value="intermediate">–õ—é–±–∏—Ç–µ–ª—å (16√ó16, 40)</option>
            <option value="expert">–ü—Ä–æ—Ñ–∏ (30√ó16, 99)</option>
            <option value="custom">–°–≤–æ—è</option>
          </select>
          <div class="custom" id="custom">
            <label>–®–∏—Ä–∏–Ω–∞ <input id="cols" type="number" min="5" max="60" value="9"></label>
            <label>–í—ã—Å–æ—Ç–∞ <input id="rows" type="number" min="5" max="40" value="9"></label>
            <label>–ú–∏–Ω—ã <input id="minesInput" type="number" min="1" value="10"></label>
          </div>
        </div>

        <button class="btn face" id="face" title="–ù–æ–≤–∞—è –∏–≥—Ä–∞">üôÇ</button>
        <button class="btn primary" id="newGame">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        <button class="btn toggle" id="flagMode" title="–†–µ–∂–∏–º —Ñ–ª–∞–≥–∞ –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤">üö© –†–µ–∂–∏–º —Ñ–ª–∞–≥–∞</button>
      </div>

      <div class="panel">
        <div class="counter" id="mines">010</div>
        <div class="counter blue" id="timer">000</div>
      </div>
    </div>

    <div class="board-wrap">
      <div id="board" class="board" role="grid" aria-label="–ü–æ–ª–µ –°–∞–ø—ë—Ä–∞"></div>
    </div>

    <div class="footer">
      <div class="hint">–ü–ö–ú ‚Äî —Ñ–ª–∞–≥ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è/–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —á–∏—Å–ª—É ‚Äî –æ—Ç–∫—Ä—ã—Ç—å —Å–æ—Å–µ–¥–µ–π ‚Ä¢ F ‚Äî —Ñ–ª–∞–≥, Enter/Space ‚Äî –æ—Ç–∫—Ä—ã—Ç—å</div>
      <div>
        –†–µ–∫–æ—Ä–¥: <strong id="best">‚Äî</strong>
      </div>
    </div>
    <div class="status" id="status"></div>
  </div>

  <script>
  (function(){
    'use strict';

    const boardEl = document.getElementById('board');
    const minesEl = document.getElementById('mines');
    const timerEl = document.getElementById('timer');
    const faceBtn = document.getElementById('face');
    const newBtn = document.getElementById('newGame');
    const diffSel = document.getElementById('difficulty');
    const customBox = document.getElementById('custom');
    const rowsInp = document.getElementById('rows');
    const colsInp = document.getElementById('cols');
    const minesInp = document.getElementById('minesInput');
    const flagModeBtn = document.getElementById('flagMode');
    const bestEl = document.getElementById('best');
    const statusEl = document.getElementById('status');
    const gameEl = document.getElementById('game');

    // Game state
    let rows = 9, cols = 9, mineTotal = 10;
    let board = []; // 2D of cells {mine, open, flag, number}
    let started = false;
    let gameOver = false;
    let timer = 0;
    let timerId = null;
    let flagsPlaced = 0;
    let cellsToOpen = 0;
    let hitRC = null;
    let flagMode = false;
    let currentDiffKey = 'novice';

    // Utils
    const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
    const format3 = n => String(n).padStart(3,'0');
    const formatTime = s => {
      const m = Math.floor(s/60);
      const ss = s%60;
      return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    };
    const bestKey = () => currentDiffKey && currentDiffKey !== 'custom' ? `ms_best_${currentDiffKey}` : null;
    const setStatus = (text, type) => {
      statusEl.className = 'status' + (type ? ' ' + type : '');
      statusEl.textContent = text || '';
    };

    function neighbors(r,c){
      const res=[];
      for(let dr=-1; dr<=1; dr++){
        for(let dc=-1; dc<=1; dc++){
          if(dr===0 && dc===0) continue;
          const nr=r+dr, nc=c+dc;
          if(nr>=0 && nr<rows && nc>=0 && nc<cols) res.push([nr,nc]);
        }
      }
      return res;
    }

    function stopTimer(){
      if(timerId){ clearInterval(timerId); timerId=null; }
    }
    function startTimer(){
      stopTimer();
      timer = 0;
      timerEl.textContent = format3(timer);
      timerId = setInterval(()=>{
        if(gameOver) return stopTimer();
        timer = Math.min(999, timer+1);
        timerEl.textContent = format3(timer);
      },1000);
    }

    function updateBestUI(){
      const k = bestKey();
      if(!k){ bestEl.textContent = '‚Äî'; return; }
      const v = localStorage.getItem(k);
      bestEl.textContent = v ? formatTime(Number(v)) : '‚Äî';
    }

    function setFace(face){ faceBtn.textContent = face; }

    function applyBoardStyles(){
      boardEl.style.setProperty('--cols', cols);
      updateCellSize();
    }
    function updateCellSize(){
      // –ü–æ–¥–≥–æ–Ω —Ä–∞–∑–º–µ—Ä–∞ –∫–ª–µ—Ç–∫–∏ –ø–æ–¥ —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞
      const maxCell = 32;
      const minCell = 20;
      const padding = 40; // –ø–æ–ª—è
      const avail = Math.max(200, Math.min(window.innerWidth, gameEl.clientWidth || window.innerWidth) - padding);
      const size = clamp(Math.floor(avail / cols), minCell, maxCell);
      document.documentElement.style.setProperty('--cell-size', size + 'px');
    }
    window.addEventListener('resize', updateCellSize);

    function makeEmptyBoard(){
      board = new Array(rows);
      for(let r=0;r<rows;r++){
        board[r] = new Array(cols);
        for(let c=0;c<cols;c++){
          board[r][c] = { mine:false, open:false, flag:false, number:0 };
        }
      }
    }

    function placeMines(firstR, firstC){
      // –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π 3√ó3 –∑–æ–Ω—É –≤–æ–∫—Ä—É–≥ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞
      const safe = new Set();
      for(let dr=-1; dr<=1; dr++){
        for(let dc=-1; dc<=1; dc++){
          const rr=firstR+dr, cc=firstC+dc;
          if(rr>=0 && rr<rows && cc>=0 && cc<cols) safe.add(rr+','+cc);
        }
      }
      let candidates = [];
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(!safe.has(r+','+c)) candidates.push([r,c]);
        }
      }
      // –ï—Å–ª–∏ –º–∞–ª–æ –º–µ—Å—Ç ‚Äî —É–º–µ–Ω—å—à–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–æ–Ω—É –¥–æ –æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏
      if(candidates.length < mineTotal){
        candidates = [];
        for(let r=0;r<rows;r++){
          for(let c=0;c<cols;c++){
            if(!(r===firstR && c===firstC)) candidates.push([r,c]);
          }
        }
      }
      // –ù–∞ —Å–ª—É—á–∞–π –∞–±—Å—É—Ä–¥–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –º–∏–Ω (—Å–≤–µ—Ä—Ö—É —É–∂–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º)
      const needed = Math.min(mineTotal, candidates.length);
      shuffle(candidates);
      for(let i=0;i<needed;i++){
        const [r,c]=candidates[i];
        board[r][c].mine = true;
      }
      // –ß–∏—Å–ª–∞
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(board[r][c].mine) continue;
          let n=0;
          for(const [nr,nc] of neighbors(r,c)) if(board[nr][nc].mine) n++;
          board[r][c].number = n;
        }
      }
    }

    function shuffle(arr){
      for(let i=arr.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
    }

    function renderBoard(){
      boardEl.innerHTML = '';
      boardEl.setAttribute('aria-rowcount', rows);
      boardEl.setAttribute('aria-colcount', cols);
      const frag = document.createDocumentFragment();
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const btn = document.createElement('button');
          btn.className = 'cell';
          btn.type = 'button';
          btn.dataset.r = r;
          btn.dataset.c = c;
          btn.setAttribute('role','gridcell');
          btn.setAttribute('aria-label','–ó–∞–∫—Ä—ã—Ç–∞—è –∫–ª–µ—Ç–∫–∞');
          btn.title = '–õ–ö–ú ‚Äî –æ—Ç–∫—Ä—ã—Ç—å; –ü–ö–ú ‚Äî —Ñ–ª–∞–≥; –î–≤–æ–π–Ω–æ–π/—Å—Ä–µ–¥–Ω–∏–π –∫–ª–∏–∫ –ø–æ —á–∏—Å–ª—É ‚Äî –æ—Ç–∫—Ä—ã—Ç—å —Å–æ—Å–µ–¥–µ–π';
          btn.tabIndex = (r===0 && c===0) ? 0 : -1;
          frag.appendChild(btn);
        }
      }
      boardEl.appendChild(frag);
    }

    function updateCounters(){
      minesEl.textContent = format3(Math.max(0, mineTotal - flagsPlaced));
    }

    function openCell(r,c, fromChord=false){
      if(gameOver) return;
      const cell = board[r][c];
      const el = getCellEl(r,c);
      if(cell.open || cell.flag) return;

      if(!started){
        // –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–Ω, —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π —Ö–æ–¥ –±—ã–ª –±–µ–∑–æ–ø–∞—Å–Ω—ã–º
        placeMines(r,c);
        started = true;
        startTimer();
      }

      cell.open = true;
      cellsToOpen--;
      renderCell(r,c);

      if(cell.mine){
        // –ü—Ä–æ–∏–≥—Ä—ã—à
        hitRC = [r,c];
        revealAllMines();
        lose();
        return;
      }

      if(cell.number === 0){
        // flood fill
        const q = [[r,c]];
        const seen = new Set([r+','+c]);
        while(q.length){
          const [cr,cc] = q.shift();
          for(const [nr,nc] of neighbors(cr,cc)){
            const ncell = board[nr][nc];
            if(!ncell.open && !ncell.flag && !ncell.mine){
              ncell.open = true;
              cellsToOpen--;
              renderCell(nr,nc);
              if(ncell.number === 0 && !seen.has(nr+','+nc)){
                seen.add(nr+','+nc);
                q.push([nr,nc]);
              }
            }
          }
        }
      }

      if(cellsToOpen === 0){
        win();
      }
    }

    function toggleFlag(r,c){
      if(gameOver) return;
      const cell = board[r][c];
      const el = getCellEl(r,c);
      if(cell.open) return;
      cell.flag = !cell.flag;
      flagsPlaced += cell.flag ? 1 : -1;
      renderCell(r,c);
      updateCounters();
    }

    function chord(r,c){
      if(gameOver) return;
      const cell = board[r][c];
      if(!cell.open || cell.number === 0) return;
      const neigh = neighbors(r,c);
      const flagged = neigh.reduce((acc,[nr,nc]) => acc + (board[nr][nc].flag ? 1:0), 0);
      if(flagged !== cell.number) return;
      for(const [nr,nc] of neigh){
        const ncell = board[nr][nc];
        if(!ncell.open && !ncell.flag){
          openCell(nr,nc, true);
          if(gameOver) break; // –º–æ–≥–ª–æ –ø–æ–¥–æ—Ä–≤–∞—Ç—å
        }
      }
    }

    function renderCell(r,c){
      const cell = board[r][c];
      const el = getCellEl(r,c);
      el.className = 'cell';
      el.textContent = '';
      if(cell.open){
        el.classList.add('open');
        el.setAttribute('aria-pressed','true');
        if(cell.mine){
          el.classList.add('mine');
          if(hitRC && hitRC[0]===r && hitRC[1]===c) el.classList.add('hit');
          el.textContent = 'üí£';
          el.setAttribute('aria-label','–ú–∏–Ω–∞');
        }else if(cell.number>0){
          el.textContent = String(cell.number);
          el.classList.add('n'+cell.number);
          el.setAttribute('aria-label', `–û—Ç–∫—Ä—ã—Ç–æ: —á–∏—Å–ª–æ ${cell.number}`);
        }else{
          el.setAttribute('aria-label','–ü—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞');
        }
      }else{
        if(cell.flag){
          el.textContent = 'üö©';
          el.classList.add('flag');
          el.setAttribute('aria-label','–§–ª–∞–≥');
        }else{
          el.setAttribute('aria-label','–ó–∞–∫—Ä—ã—Ç–∞—è –∫–ª–µ—Ç–∫–∞');
        }
      }
    }

    function getCellEl(r,c){
      return boardEl.children[r*cols + c];
    }

    function revealAllMines(){
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cell = board[r][c];
          if(cell.mine){
            if(!cell.open){
              cell.open = true;
              renderCell(r,c);
            }
          }
        }
      }
    }

    function disableBoard(){
      gameOver = true;
      stopTimer();
    }

    function win(){
      disableBoard();
      setFace('üòé');
      setStatus('–ü–æ–±–µ–¥–∞!', 'win');
      // –ê–≤—Ç–æ—Ñ–ª–∞–≥–∏ (–∫—Ä–∞—Å–∏–≤–æ, –Ω–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cell = board[r][c];
          if(cell.mine && !cell.flag){
            cell.flag = true;
            flagsPlaced++;
            renderCell(r,c);
          }
        }
      }
      updateCounters();
      // –†–µ–∫–æ—Ä–¥
      const key = bestKey();
      if(key){
        const best = Number(localStorage.getItem(key) || Infinity);
        if(timer < best){
          localStorage.setItem(key, String(timer));
        }
        updateBestUI();
      }
    }

    function lose(){
      disableBoard();
      setFace('üòµ');
      setStatus('–ë—É–º! –í—ã –ø–æ–¥–æ—Ä–≤–∞–ª–∏—Å—å.', 'lose');
    }

    function resetStatus(){
      setStatus('');
    }

    function newGame(){
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
      if(diffSel.value !== 'custom'){
        switch(diffSel.value){
          case 'novice': rows=9; cols=9; mineTotal=10; currentDiffKey='novice'; break;
          case 'intermediate': rows=16; cols=16; mineTotal=40; currentDiffKey='intermediate'; break;
          case 'expert': rows=16; cols=30; mineTotal=99; currentDiffKey='expert'; break;
        }
      }else{
        currentDiffKey = 'custom';
        rows = clamp(parseInt(rowsInp.value||'9',10), +rowsInp.min, +rowsInp.max);
        cols = clamp(parseInt(colsInp.value||'9',10), +colsInp.min, +colsInp.max);
        const maxMines = rows*cols - 1;
        minesInp.max = String(maxMines);
        mineTotal = clamp(parseInt(minesInp.value||'10',10), 1, maxMines);
        minesInp.value = String(mineTotal);
      }
      // Init
      setFace('üôÇ');
      resetStatus();
      started = false;
      gameOver = false;
      flagsPlaced = 0;
      hitRC = null;
      stopTimer();
      timer = 0;
      timerEl.textContent = format3(timer);
      makeEmptyBoard();
      cellsToOpen = rows*cols - mineTotal;
      applyBoardStyles();
      renderBoard();
      updateCounters();
      updateBestUI();
      // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤—É—é –∫–ª–µ—Ç–∫—É
      if(boardEl.firstElementChild) boardEl.firstElementChild.focus();
    }

    // Event handlers
    diffSel.addEventListener('change', ()=>{
      const isCustom = diffSel.value === 'custom';
      customBox.classList.toggle('show', isCustom);
      newGame();
    });

    [rowsInp, colsInp, minesInp].forEach(inp=>{
      if(!inp) return;
      inp.addEventListener('change', ()=>{
        // –ü–æ–¥–ø—Ä–∞–≤–∏—Ç—å –º–∏–Ω –ø–æ –Ω–æ–≤–æ–π –ø–ª–æ—â–∞–¥–∏
        if(inp === rowsInp || inp === colsInp){
          const r = clamp(parseInt(rowsInp.value||'9',10), +rowsInp.min, +rowsInp.max);
          const c = clamp(parseInt(colsInp.value||'9',10), +colsInp.min, +colsInp.max);
          const maxMines = r*c - 1;
          minesInp.max = String(maxMines);
          if(parseInt(minesInp.value||'10',10) > maxMines){
            minesInp.value = String(maxMines);
          }
        }
        newGame();
      });
    });

    newBtn.addEventListener('click', newGame);
    faceBtn.addEventListener('click', newGame);

    flagModeBtn.addEventListener('click', ()=>{
      flagMode = !flagMode;
      flagModeBtn.classList.toggle('active', flagMode);
      flagModeBtn.textContent = flagMode ? 'üö© –†–µ–∂–∏–º —Ñ–ª–∞–≥–∞: –í–ö–õ' : 'üö© –†–µ–∂–∏–º —Ñ–ª–∞–≥–∞';
    });

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø–æ –¥–æ—Å–∫–µ
    boardEl.addEventListener('click', (e)=>{
      const el = e.target.closest('.cell');
      if(!el || gameOver) return;
      const r = +el.dataset.r, c = +el.dataset.c;
      if(flagMode){
        toggleFlag(r,c);
      }else{
        openCell(r,c);
      }
    });

    boardEl.addEventListener('contextmenu', (e)=>{
      const el = e.target.closest('.cell');
      if(!el || gameOver) return;
      e.preventDefault();
      const r = +el.dataset.r, c = +el.dataset.c;
      toggleFlag(r,c);
    });

    boardEl.addEventListener('auxclick', (e)=>{
      if(e.button !== 1) return;
      const el = e.target.closest('.cell');
      if(!el || gameOver) return;
      const r = +el.dataset.r, c = +el.dataset.c;
      chord(r,c);
    });

    boardEl.addEventListener('dblclick', (e)=>{
      const el = e.target.closest('.cell');
      if(!el || gameOver) return;
      const r = +el.dataset.r, c = +el.dataset.c;
      chord(r,c);
    });

    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
    boardEl.addEventListener('keydown', (e)=>{
      const active = document.activeElement;
      if(!active || !active.classList.contains('cell')) return;
      const r = +active.dataset.r, c = +active.dataset.c;
      let nr=r, nc=c;
      const key = e.key;
      if(key === 'ArrowLeft'){ nc = Math.max(0, c-1); }
      else if(key === 'ArrowRight'){ nc = Math.min(cols-1, c+1); }
      else if(key === 'ArrowUp'){ nr = Math.max(0, r-1); }
      else if(key === 'ArrowDown'){ nr = Math.min(rows-1, r+1); }
      else if(key === ' ' || key === 'Enter'){
        e.preventDefault();
        if(flagMode) toggleFlag(r,c); else openCell(r,c);
        return;
      }else if(key.toLowerCase() === 'f'){
        e.preventDefault();
        toggleFlag(r,c);
        return;
      }
      if(nr!==r || nc!==c){
        e.preventDefault();
        const next = getCellEl(nr,nc);
        if(next) next.focus();
      }
    });

    // Init on load
    newGame();

  })();
  </script>
</body>
</html>